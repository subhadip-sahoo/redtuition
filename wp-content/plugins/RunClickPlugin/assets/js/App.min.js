/* * Screets Chat * Application scripts * * Copyright (c) 2013 Screets */
(function (a) {
    a(document).ready(function () {
        c.init()
    });
    var c = {
        data: {
            first_time: !0,
            last_log_ID: 0,
            no_activity: 0,
            logged_in: !1,
            sender: "",
            win_is_active: 0,
            g_hangout_box_visible: !1
        },
        init: function () {
            var d = !1;
            window.onfocus = function () {
                c.data.win_is_active = 1
            };
            window.onblur = function () {
                c.data.win_is_active = 0
            };
            !0 == g_hangout.is_admin && (a.sc_POST("login", "action=g_hangout_ajax_callback&f_chat_user_name=" + g_hangout.username + "&f_chat_user_email=" + g_hangout.email + "&f_chat_is_admin=true", function (a) {
                d = !1;
                a.error ? c.display_error(a.error) : c.login(a.name, a.gravatar, !0)
            }), a(document).on("click", ".g-hangout-users .user", function () {
                var b = a(this).attr("data-receiver-id"),
                    d = a(this).attr("data-visitor-id");
                c.open_new_tab(b, d, !0);
                return !1
            }), a("ul.g-hangout-tabs").each(function () {
                var b, c = a(this).find("li");
                c.addClass("active");
                c.not(b).each(function () {
                    a(a(this).attr("href")).hide()
                });
                a(document).on("click", ".g-hangout-tab-content", function () {
                    a("ul.g-hangout-tabs li.active").removeClass("new-msg")
                });
                a(this).on("click", "li a", function (d) {
                    a("ul.g-hangout-tabs li").removeClass("active new-msg");
                    a(".g-hangout-tab-content").removeClass("active");
                    b = a(this).parent();
                    c = a(a(this).attr("href"));
                    b.addClass("active");
                    c.addClass("active");
                    a(".sc-cnv-wrap").scrollTop(1E4);
                    c.find(".f-chat-line").focus();
                    d.preventDefault()
                });
                a(this).on("click", "li .close", function (b) {
                    var c = a(this).prev().attr("data-receiver-id");
                    a("ul.g-hangout-tabs li").removeClass("active new-msg");
                    a(".g-hangout-tab-content").removeClass("active");
                    a(".console-tab").addClass("active");
                    a("#Console").addClass("active");
                    a("#Tab_" + c).remove();
                    a("#Receiver_" + c).remove();
                    b.preventDefault()
                })
            }), a(".g-hangout-login-btn").click(function () {
                var b = a(this);
                c.data.current_status = a(this).attr("data-status");
                "online" == c.data.current_status ? a.sc_POST("offline", "action=g_hangout_ajax_callback", function () {
                    a('.user[data-user-type="1"]').fadeOut(1E3);
                    c.get_online_users();
                    b.attr("data-status", "offline").html('<i class="sc-icon-offline"></i> ' + g_hangout.tr_offline);
                    c.data.current_status = "offline";
                    a("#Chat_console").removeClass("sc-online").addClass("sc-offline");
                    c.play_sound("offline")
                }) : "offline" == c.data.current_status && a.sc_POST("online", "action=g_hangout_ajax_callback", function () {
                    c.get_online_users();
                    a('.user[data-user-type="ME"]').show();
                    b.attr("data-status", "online").html('<i class="sc-icon-online"></i> ' + g_hangout.tr_online);
                    c.data.current_status = "online";
                    a("#Chat_console").removeClass("sc-offline").addClass("sc-online");
                    c.play_sound("online")
                })
            }), a(document).on("click", ".g-hangout-refresh", function () {
                receiver_ID = a(this).parent().parent().parent().parent().attr("data-receiver-id");
                visitor_ID = a("#User_" + receiver_ID).attr("data-visitor-id");
                c.get_user_info(visitor_ID, receiver_ID)
            }));
            g_hangout.is_admin || (a("#SC_send_form_btn").click(function () {
                a("#SC_contact_form").submit()
            }), a("#SC_contact_form").submit(function () {
                a(".g-hangout-notification").fadeIn(100).removeClass("error success").html(g_hangout.tr_sending + "...");
                a.sc_POST("send_contact_from", a(this).serialize(), function (b) {
                    b.error ? a(".g-hangout-notification").addClass("error").html(b.error) : (a(".g-hangout-notification").addClass("success").html(b.message).delay(1500).fadeOut(500), a(".g-hangout-header-title").html(b.message).delay(4E3).queue(function (b) {
                        a(this).html(g_hangout.tr_offline_header);
                        b()
                    }), a('#SC_contact_form input[type="text"], #SC_contact_form textarea').val(""), setTimeout(c.hide_chatbox, 2700))
                });
                return !1
            }), a("#SC_start_chat_btn").click(function () {
                a("#SC_login_form").submit()
            }), a("#SC_login_form input").keydown(function (b) {
                13 == b.keyCode && a("#SC_login_form").submit()
            }), a("#SC_login_form").submit(function () {
                if (d) return !1;
                d = !0;
                a.sc_POST("login", a(this).serialize(), function (a) {
                    d = !1;
                    a.error ? c.display_error(a.error) : c.login(a.name, a.gravatar, !0)
                });
                return !1
            }), 1 == g_hangout.use_css_anim ? setTimeout(c.animate_chatbox, 500 * g_hangout.delay) : setTimeout(c.animate_chatbox, 1E3 * g_hangout.delay));
            a(document).on("keydown", ".f-chat-line", function (b) {
                13 == b.keyCode && !b.shiftKey && (b.preventDefault(), a(this).parent().submit(), a(this).val(""), a(this).trigger("autosize"))
            });
            a(document).on("submit", "#Reply_form", function () {
                var b = a(this).find(".f-receiver-id").val(),
                    e = a.trim(a(this).find(".f-chat-line").val()),
                    f = a(this).serialize(),
                    j = a(".f-chat-line");
                if (0 == e.length || d) return !1;
                d = !0;
                var h = "t" + Math.round(1E6 * Math.random()),
                    g = {
                        ID: h,
                        author: c.data.name,
                        gravatar: c.data.gravatar,
                        receiver_ID: b,
                        chat_line: e.replace(/</g, "&lt;").replace(/>/g, "&gt;")
                    };
                j.addClass("g-hangout-sending");
				j.attr('disabled','disabled');
                c.add_chat_line(a.extend({}, g));
                a.sc_POST("send_chat_msg", f, function (b) {
                    d = !1;
                    a(".f-chat-line").val("").removeClass("g-hangout-sending");
                    a("div.chat-" + h).remove();
					j.attr('disabled',false);
                    b.error ? (c.display_error(b.error), a("#Reply_form .f-chat-line").attr("disabled", "disabled").addClass("g-hangout-error")) : (g.ID = b.insert_ID, c.add_chat_line(a.extend({}, g)))
                });
                return !1
            });
            a(document).on("click", ".g-hangout-btn-logout", function (f) {
               /* window.location.href = "./";
                a.sc_POST("logout", "action=g_hangout_ajax_callback");
                return !1*/
				/*bhuvnesh*/
				$(this).hide();
				setTimeout(function(){$(".g-hangout-btn-logout").show()},3000);
				c.get_chat_lines(f);
                return !1
            });
            a.sc_GET("is_user_logged_in", "action=g_hangout_ajax_callback", function (a) {
                var d = !0;
                !g_hangout.is_admin && !0 == g_hangout.is_op && (d = !1);
                a.logged && d && c.login(a.user.name, a.user.email, !1)
            });
            (function e() {
                c.get_online_users(e)
            })();
            (function f() {
                c.get_chat_lines(f)
            })()
        },
        login: function (d, b, e) {
            c.data.name = d;
            c.data.gravatar = b;
            c.data.logged_in = !0;
            !0 == g_hangout.is_admin ? (a(".g-hangout-login-btn").attr("data-status", "online").html('<i class="sc-icon-online"></i> ' + g_hangout.tr_online), a("#Chat_console").addClass("sc-online")) : (c.open_chatbox(), !0 == e ? a(".g-hangout-wrapper").fadeOut(function () {
                a(".g-hangout-notification").html("").hide();
                a("#Conversation").fadeIn();
                a(".f-chat-line").focus().autosize();
                a(".sc-cnv-wrap").scrollTop(1E4)
            }) : (a(".g-hangout-wrapper").hide(), "on" == a.cookie("g_hangout_chatbox_status") && (delay = 1 == g_hangout.use_css_anim ? 500 * g_hangout.delay : 1E3 * g_hangout.delay, setTimeout(function () {
                a("#Conversation").show();
                a(".f-chat-line").autosize();
                a(".sc-cnv-wrap").scrollTop(1E4)
            }, delay), c.data.g_hangout_box_visible = !0)));
            c.data.first_time = !1
        },
        render: function (a, b) {
            var c = [];
            switch (a) {
            case "login_top_bar":
                c = ['<span><img src="', b.gravatar, '" width="23" height="23" />', '<span class="name">', b.name, '</span><a href="" class="logoutButton rounded">', b.tr_logout, "</a></span>"];
                break;
            case "chat_line":
                c = ['<div class="sc-msg-wrap chat chat-', b.ID, '" data-user-id="', b.author, '"><div class="g-hangout-time">', b.time, '</div><div class="sc-usr-avatar"><img src="', b.gravatar, '" width="38" height="38" onload="this.style.visibility=\'visible\'" />', '</div><div class="sc-msg"><div class="sc-usr-name">', b.author, ':</div><div class="g-hangout-line">', b.chat_line, '</div></div><div class="clearfix"></div></div>'];
                break;
            case "user":
                c = ['<a id="User_', b.name, '" href="#Receiver_', b.ID, '" class="user" data-receiver-id="', b.name, '" data-visitor-id="', 1 == b.type ? b.ID : b.visitor_ID, '" data-user-type="', b.type, '"><img class="avatar" src="', b.gravatar, '" onload="this.style.visibility=\'visible\'" /> <div class="username"> <strong>', b.name, "</strong> (", b.email, ")<small>", b.tagline, "</small></div></a>"];
                break;
            case "new_tab_title":
                c = ['<li class="', b.custom_class, '" id="Tab_', b.ID, '"><a href="#Receiver_', b.ID, '" data-receiver-id="', b.ID, '">', b.ID, '</a> <button type="button" class="close">&times;</button></li>'];
                break;
            case "new_tab_content":
                c = ['<div id="Receiver_', b.ID, '" data-receiver-id="', b.ID, '" class="', b.custom_class, ' g-hangout-tab-content"><div class="g-hangout-inner"><div id="SC_cnv_wrap" class="sc-cnv-wrap"><div class="g-hangout-user-agent">', b.user_info ? b.user_info : '<a href="javascript:void(0)" class="g-hangout-refresh">Refresh</a>', '</div></div><div class="g-hangout-tip"></div></div><form id="Reply_form" method="post" action="" class="g-hangout-reply"><input type="hidden" name="action" value="g_hangout_ajax_callback" /><input type="hidden" name="receiver_ID" class="f-receiver-id" value="', b.ID, '" /><input type="hidden" name="visitor_ID" class="f-visitor-id" value="', b.visitor_ID, '" /><textarea name="chat_line" class="f-chat-line" maxlength="700" placeholder="', g_hangout.tr_write_a_reply, '"></textarea></form></div>']
            }
            return c.join("")
        },
        open_new_tab: function (d, b, e) {
            user_type = a('.g-hangout-users a[data-visitor-id="' + b + '"]').attr("data-user-type");
            var f = [];
            f.ID = d;
            f.visitor_ID = b;
            f.custom_class = "";
            f.user_info = "1" == user_type || !b ? "" : g_hangout.tr_loading + "...";
            if (0 == a(".g-hangout-tabs li#Tab_" + d).length) {
                if (1 == a(".g-hangout-tabs .console-tab.active").length || e) a(".g-hangout-tabs li").removeClass("active"), a(".g-hangout-tab-content").removeClass("active"), f.custom_class = "active ";
                a(".g-hangout-tabs").append(c.render("new_tab_title", f));
                a(".g-hangout-tab-contents").append(c.render("new_tab_content", f));
                a("#Receiver_" + d + " .f-chat-line").focus()
            }
            c.get_user_info(b, d);
            return !1
        },
        get_user_info: function (d, b) {
            c.data.receiver_ID = b;
            a.sc_GET("user_info", "action=g_hangout_ajax_callback&ID=" + d, function (a) {
                "null" != a.device_name && (c.data.user_info = a.device_name + " " + a.device_version + " - " + a.platform + ", " + a.ip_address + ' &nbsp; <a href="admin.php?page=g_hangout_m_chat_logs&action=edit&visitor_ID=' + d + '" target="_blank">' + g_hangout.tr_chat_logs + "</a>", c.update_user_info())
            })
        },
        update_user_info: function () {
            a("#Receiver_" + c.data.receiver_ID + " .g-hangout-user-agent").html(c.data.user_info)
        },
        add_chat_line: function (d) {
            if (!0 == g_hangout.is_admin) {
                d.author == g_hangout.username && d.receiver_ID == g_hangout.username ? c.data.sender = g_hangout.username : d.receiver_ID == g_hangout.username ? c.data.sender = d.author : d.author == g_hangout.username ? c.data.sender = d.receiver_ID : "__OP__" == d.receiver_ID && (c.data.sender = d.author);
                if (c.data.sender) {
                    var b = a("#User_" + c.data.sender).attr("data-visitor-id");
                    c.open_new_tab(c.data.sender, b);
                    c.update_user_info()
                }
                a("#Tab_" + d.author + ":not(.active)").addClass("new-msg")
            }
            b = new Date;
            d.time && b.setUTCHours(d.time.hours, d.time.minutes);
            d.time = (10 > b.getHours() ? "0" : "") + b.getHours() + ":" + (10 > b.getMinutes() ? "0" : "") + b.getMinutes();
            b = c.render("chat_line", d);
            exists = a(".sc-cnv-wrap .chat-" + d.ID);
            exists.length && exists.remove();
            c.data.last_log_ID || a(".sc-cnv-wrap .sc-lead").remove();
            var e = !0 == g_hangout.is_admin ? a("#Receiver_" + c.data.sender + " .sc-cnv-wrap") : a(".sc-cnv-wrap");
            if ("t" != d.ID.toString().charAt(0)) {
                var f = e.find(".chat-" + (+d.ID - 1));
                f.length ? f.after(b) : e.append(b)
            } else e.append(b);
            a(".sc-cnv-wrap").scrollTop(1E5);
            c.data.last_user = d.author
        },
        get_chat_lines: function (d) {
            !c.data.logged_in && !1 == g_hangout.is_admin ? setTimeout(d, 1E3) : a.sc_GET("get_chat_lines", {
                last_log_ID: c.data.last_log_ID,
                action: "g_hangout_ajax_callback",
                sender: c.data.sender
            }, function (a) {
                for (var e = 0; e < a.chats.length; e++) c.add_chat_line(a.chats[e]);
                a.chats.length ? (c.data.no_activity = 0, c.data.last_log_ID = a.chats[e - 1].ID, !0 != c.data.first_time && (0 == c.data.win_is_active || !0 == g_hangout.is_admin) && c.play_sound("new_message")) : c.data.no_activity++;
         		/*a = 1E3;*/               
                /*3 < c.data.no_activity && (a = 2E3);
                10 < c.data.no_activity && (a = 5E3);
                20 < c.data.no_activity && (a = 15E3);*/
				/* bhuvnesh */
				 a = 20E3;
				3 < c.data.no_activity && (a = 30E3);
                5 < c.data.no_activity && (a = 50E3);
                10 < c.data.no_activity && (a = 70E3);
				15 < c.data.no_activity && (a = 500E3);		
                setTimeout(d, a)
            })
        },
        get_online_users: function (d) {
            !c.data.logged_in && !1 == g_hangout.is_admin ? setTimeout(d, 15E3) : a.sc_GET("get_online_users", {
                action: "g_hangout_ajax_callback"
            }, function (b) {
                if (!0 == g_hangout.is_admin) {
                    for (var e = [], f = 0; f < b.users.length; f++) b.users[f] && e.push(c.render("user", b.users[f]));
                    f = "";
                    f = 1 > b.total ? g_hangout.tr_no_one_online : 1 == b.total ? g_hangout.tr_1_person_online : g_hangout.tr_x_people_online.replace("%s", b.total);
                    e.push('<p class="count">' + f + "</p>");
                    a("#People_list .g-hangout-users").html(e.join(""))
					/* bhuvnesh */
					setTimeout(d, 15E3)
                }
               /* setTimeout(d, 15E3)*/
            })
        },
        animate_chatbox: function () {
            var d = a("#g_hangout_box"),
                b = a("#g_hangout_box .g-hangout-header"),
                e = d.innerHeight(),
                f = b.innerHeight();
            d.css("bottom", "-" + e + "px");
            d.css("visibility", "visible");
            1 == g_hangout.use_css_anim ? (d.css("bottom", "-" + (e - f) + "px").addClass("g-hangout-animated g-hangout-bounce-in-up"), b.click(function () {
                a.removeCookie("g_hangout_chatbox_status");
                e = d.innerHeight();
                f = b.innerHeight();
                !1 == c.data.g_hangout_box_visible ? (e = d.innerHeight(), f = b.innerHeight(), d.css("bottom", 0).addClass("g-hangout-css-anim"), setTimeout(function () {
                    480 < window.innerWidth && (a("#f_chat_user_name").length ? a("#f_chat_user_name, .f-chat-line").focus() : a("#f_chat_user_email, .f-chat-line").focus())
                }, 500), !0 == c.data.logged_in && (a("#Conversation").show(), setTimeout(function () {
                    a(".f-chat-line").focus().autosize()
                }, 500)), a.cookie("g_hangout_chatbox_status", "on", {
                    expires: 1
                }), c.data.g_hangout_box_visible = !0) : (d.css("bottom", "-" + (e - f) + "px"), a.cookie("g_hangout_chatbox_status", "off", {
                    expires: 1
                }), c.data.g_hangout_box_visible = !1)
            })) : (d.stop().animate({
                bottom: "+=" + f
            }, {
                duration: 900,
                easing: "easeOutBack"
            }), b.click(function () {
                a("#Conversation").show();
                a.removeCookie("g_hangout_chatbox_status");
                e = d.innerHeight();
                f = b.innerHeight();
                !1 == c.data.g_hangout_box_visible ? (d.stop().animate({
                    bottom: 0
                }, {
                    duration: 200,
                    easing: "easeOutExpo",
                    complete: function () {
                        480 < window.innerWidth && (a("#f_chat_user_name").length ? a("#f_chat_user_name, .f-chat-line").focus() : a("#f_chat_user_email, .f-chat-line").focus())
                    }
                }), a.cookie("g_hangout_chatbox_status", "on", {
                    expires: 1
                }), c.data.g_hangout_box_visible = !0) : (a.cookie("g_hangout_chatbox_status", "off", {
                    expires: 1
                }), d.stop().animate({
                    bottom: "-" + (e - f)
                }, {
                    duration: 190,
                    easing: "easeOutExpo"
                }), a.cookie("g_hangout_chatbox_status", "off", {
                    expires: 1
                }), c.data.g_hangout_box_visible = !1)
            }))
        },
        open_chatbox: function () {
            var c = a("#g_hangout_box");
            a("#Reply_form .f-chat-line").removeAttr("disabled").removeClass("g-hangout-error");
            1 == g_hangout.use_css_anim ? c.css("bottom", 0) : (c.stop().animate({
                bottom: 0
            }, {
                duration: 200,
                easing: "easeOutExpo"
            }), a("#f_chat_user_name, .f-chat-line").focus())
        },
        hide_chatbox: function () {
            var d = a("#g_hangout_box"),
                b = a("#g_hangout_box .g-hangout-header");
            g_hangout_box_h = d.innerHeight();
            g_hangout_header_h = b.innerHeight();
            1 == g_hangout.use_css_anim ? d.css("bottom", "-" + (g_hangout_box_h - g_hangout_header_h) + "px") : d.stop().animate({
                bottom: "-" + (g_hangout_box_h - g_hangout_header_h)
            }, {
                duration: 190,
                easing: "easeOutExpo"
            });
            c.data.g_hangout_box_visible = !1
        },
        add_source: function (c, b) {
            a("<source>").attr("src", b).appendTo(c)
        },
        play_sound: function (d) {
            var b = a("<audio />", {
                autoPlay: "autoplay"
            });
            c.add_source(b, g_hangout.plugin_url + "/assets/sounds/" + d + ".mp3");
            c.add_source(b, g_hangout.plugin_url + "/assets/sounds/" + d + ".ogg");
            c.add_source(b, g_hangout.plugin_url + "/assets/sounds/" + d + ".wav");
            b.appendTo("body")
        },
        display_error: function (c) {
            a(".g-hangout-notification").show().addClass("error").html("").delay(500).html(c)
        }
    };
    a.sc_POST = function (c, b, e) {
        a.post(g_hangout.ajaxurl + "?mode=" + c, b, e, "json").error(function (a) {
            console.log(a);
            return !1
        })
    };
    a.sc_GET = function (c, b, e) {
        a.get(g_hangout.ajaxurl + "?mode=" + c, b, e, "json").error(function (a) {
            console.log(a);
            return !1
        })
    }
})(window.jQuery || window.Zepto);